"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var t,n=e(require("path")),r=e(require("mkdirp")),o=e(require("process")),i=e(require("net")),s=e(require("lodash")),a=require("tsee"),c=e(require("get-port")),l=require("child_process");function u(e,t){var n=function(n,r,o){var i=t+": "+r;o?e[n](i,o):e[n](i)};return{debug:function(e,t){return n("debug",e,t)},info:function(e,t){return n("info",e,t)},error:function(e,t){return n("error",e,t)}}}function d(e){return e.exe+" exited with "+("number"==typeof e.code?"status "+e.code:e.signal?"signal "+e.signal:"error "+e.err)}function g(e,t){void 0===t&&(t=console);var n,r,o,i=new a.EventEmitter,c=exports.ServiceStatus.NotStarted,u=null,d=null,g=function(e,o,i){void 0===e&&(e=null),void 0===o&&(o=null),void 0===i&&(i=null),t.debug("Service onStopped",r={exe:n.command,code:e,signal:o,err:i}),d&&(clearTimeout(d),d=null),u=null,f(exports.ServiceStatus.Stopped)},p=function(){var e={exe:n?n.command:"",code:null,signal:null,err:null};switch(c){case exports.ServiceStatus.NotStarted:case exports.ServiceStatus.Starting:return new Promise((function(t){c=exports.ServiceStatus.Stopped,t(r=e)}));case exports.ServiceStatus.Started:case exports.ServiceStatus.Stopping:return new Promise((function(e){t.debug("Service.stop: waiting for ServiceStatus.Stopped"),i.on("statusChanged",(function(t){t===exports.ServiceStatus.Stopped&&r&&e(r)}))}));case exports.ServiceStatus.Stopped:return new Promise((function(t){return t(r||e)}))}},f=function(e){t.debug("setStatus "+exports.ServiceStatus[c]+" -> "+exports.ServiceStatus[e]),i.emit("statusChanged",c=e)};return{start:function(){try{switch(c){case exports.ServiceStatus.NotStarted:return f(exports.ServiceStatus.Starting),o=e.then((function(e){return n=e,function(){try{var e=""+s.map(n.extraEnv,(function(e,t){return t+"="+e+" "})).join("")+n.command+" "+n.args.join(" ");t.info("Service.start: trying to start "+e,n);var r=[n.supportsCleanShutdown?"pipe":"ignore","inherit","inherit"],o=n.cwd?{cwd:n.cwd}:{},i=n.extraEnv?{env:Object.assign({},process.env,n.extraEnv)}:{},a=Object.assign({stdio:r},o,i);try{u=l.spawn(n.command,n.args,a)}catch(e){throw t.error("Service.start: child_process.spawn() failed: "+e),t.error("Service.start: child_process.spawn("+n.command+", "+n.args.join(" ")+", ...)",a),e}return f(exports.ServiceStatus.Started),u.on("exit",(function(e,t){g(e,t)})),u.on("error",(function(e){t.error("Service.start: child_process failed: "+e),g(null,null,e)})),Promise.resolve(u.pid)}catch(e){return Promise.reject(e)}}()})),Promise.resolve(o);case exports.ServiceStatus.Starting:return t.info("Service.start: already starting"),Promise.resolve(o);case exports.ServiceStatus.Started:return t.info("Service.start: already started"),Promise.resolve(u?u.pid:-1);case exports.ServiceStatus.Stopping:return t.info("Service.start: cannot start - already stopping"),Promise.resolve(-1);case exports.ServiceStatus.Stopped:return t.info("Service.start: cannot start - already stopped"),Promise.resolve(-1)}return Promise.resolve()}catch(e){return Promise.reject(e)}},stop:function(e){void 0===e&&(e=60);try{switch(c){case exports.ServiceStatus.NotStarted:t.info("Service.stop: cannot stop - never started");break;case exports.ServiceStatus.Starting:case exports.ServiceStatus.Started:!function(e){t.info("Service.stop: trying to stop "+n.command,n),f(exports.ServiceStatus.Stopping),u&&(n.supportsCleanShutdown&&u.stdin?u.stdin.end():u.kill("SIGTERM")),d=setTimeout((function(){u&&(t.info("Service.stop: timed out after "+e+" seconds. Killing process "+u.pid+"."),u.kill("SIGKILL"))}),1e3*e)}(e);break;case exports.ServiceStatus.Stopping:0===e&&u?(t.info("Service.stop: was already stopping, but will now kill process "+u.pid+" immediately"),u.kill("SIGKILL")):t.info("Service.stop: already stopping");break;case exports.ServiceStatus.Stopped:t.info("Service.stop: already stopped")}return Promise.resolve(p())}catch(e){return Promise.reject(e)}},waitForExit:p,getStatus:function(){return c},getProcess:function(){return u},events:i}}(t=exports.ServiceStatus||(exports.ServiceStatus={}))[t.NotStarted=0]="NotStarted",t[t.Starting=1]="Starting",t[t.Started=2]="Started",t[t.Stopping=3]="Stopping",t[t.Stopped=4]="Stopped";var p={mainnet:{configFile:"configuration-mainnet.yaml",genesisFile:"mainnet-genesis.json",genesisHash:"5f20df933584822601f9e3f8c024eb5eb252fe8cefb24d1317dc3d432e940ebb",topologyFile:"mainnet-topology.json"}},f={itn_rewards_v1:{configFile:"itn_rewards_v1-config.yaml",genesisBlock:{hash:"8e4d2a343f3dcf9330ad9035b3e8d168e6728904262f2c434a4f8f934ec7b676"}},self:{configFile:"config.yaml",genesisBlock:{file:"block0.bin",hash:"f8c0622ea4b768421fea136a6e5a4e3b4c328fc5f16fad75817e40c8a2a56a56"},secretFile:["secret.yaml"]}},S=function(){function e(e,t){var o=this;void 0===t&&(t=console),this.apiPort=0,t.debug("Launcher init"),this.logger=t;var i=function(e,t){var o=n.join(e.stateDir,e.nodeConfig.kind,e.networkName);t.info("Creating base directory "+o+" (if it doesn't already exist)");var i=r(o).then((function(){return function(e,t){switch(t.nodeConfig.kind){case"jormungandr":return function(e,t){try{var r=function(){var r=function(e,t){return{configFile:n.join(t.configurationDir,t.network.configFile),restListen:"127.0.0.1:"+(t.restPort||0),genesisBlock:{file:"file"in t.network.genesisBlock?n.join(t.configurationDir,t.network.genesisBlock.file):void 0,hash:"hash"in t.network.genesisBlock?t.network.genesisBlock.hash:void 0},storageDir:n.join(e,"chain"),secretFile:s.map(t.network.secretFile||[],(function(e){return n.join(t.configurationDir,e)})),extra:t.extraArgs}}(e,t);return{command:"jormungandr",args:["--config",r.configFile,"--storage",r.storageDir].concat(r.restListen?["--rest-listen",r.restListen]:[]).concat(r.genesisBlock.file?["--genesis-block",r.genesisBlock.file]:r.genesisBlock.hash?["--genesis-block-hash",r.genesisBlock.hash]:[]).concat(s.flatMap(r.secretFile||[],(function(e){return["--secret",e]}))).concat(r.extra||[]),supportsCleanShutdown:!1}},o=function(){if(!t.restPort)return Promise.resolve(c()).then((function(e){t.restPort=e}))}();return Promise.resolve(o&&o.then?o.then(r):r())}catch(e){return Promise.reject(e)}}(e,t.nodeConfig);case"byron":return function(e,t){try{return Promise.resolve(c()).then((function(r){var o=function(e,t,r){return t.socketDir||(t.socketDir="sockets"),{socketDir:t.socketDir,topologyFile:n.join(t.configurationDir,t.network.topologyFile),databaseDir:"chain",genesis:{file:n.join(t.configurationDir,t.network.genesisFile),hash:t.network.genesisHash},listen:{port:r},configFile:n.join(t.configurationDir,t.network.configFile)}}(0,t,r);return{command:"cardano-node",args:["--socket-dir",o.socketDir,"--topology",o.topologyFile,"--database-path",o.databaseDir,"--genesis-file",o.genesis.file,"--genesis-hash",o.genesis.hash,"--port",""+o.listen.port,"--config",o.configFile].concat(o.listen.address?["--host-addr",o.listen.address]:[]).concat(o.validateDb?["--validate-db"]:[]).concat(o.signingKey?["--signing-key",o.signingKey]:[]).concat(o.delegationCertificate?["--delegation-certificate",o.delegationCertificate]:[]).concat(o.extra||[]),supportsCleanShutdown:!1,cwd:e}}))}catch(e){return Promise.reject(e)}}(e,t.nodeConfig);case"shelley":return function(e){try{throw new Error("shelley backend not implemented")}catch(e){return Promise.reject(e)}}()}}(o,e)}));return{wallet:i.then((function(t){return function(e,t,r){try{var o=function(r){var o={command:"cardano-wallet-"+t.nodeConfig.kind,args:["serve","--shutdown-handler","--port",""+r,"--database",n.join(e,"wallet")].concat(t.listenAddress?["--listen-address",t.listenAddress]:[],t.syncToleranceSeconds?["--sync-tolerance",t.syncToleranceSeconds+"s"]:[]),extraEnv:t.stakePoolRegistryUrl?{CARDANO_WALLET_STAKE_POOL_REGISTRY_URL:t.stakePoolRegistryUrl}:void 0,supportsCleanShutdown:!0,apiPort:r},i=function(e){return s.assign(o,{args:o.args.concat(e)})};switch(t.nodeConfig.kind){case"jormungandr":return i(["--genesis-block-hash",t.nodeConfig.network.genesisBlock.hash,"--node-port",""+t.nodeConfig.restPort]);case"byron":return i(t.nodeConfig.socketDir?["--node-socket",t.nodeConfig.socketDir]:[]);case"shelley":return o}},i=t.apiPort;return Promise.resolve(i?o(i):Promise.resolve(c()).then(o))}catch(e){return Promise.reject(e)}}(o,e)})),node:i}}(e,t);this.walletService=g(i.wallet,u(t,"wallet")),this.nodeService=g(i.node,u(t,"node")),this.walletBackend={getApi:function(){return new v(o.apiPort)},events:new a.EventEmitter},i.wallet.then((function(e){o.apiPort=e.apiPort})),this.walletService.events.on("statusChanged",(function(e){e===exports.ServiceStatus.Stopped&&(o.logger.debug("wallet exited"),o.stop())})),this.nodeService.events.on("statusChanged",(function(e){e===exports.ServiceStatus.Stopped&&(o.logger.debug("node exited"),o.stop())})),this.installSignalHandlers()}var t=e.prototype;return t.start=function(){var e=this;return this.nodeService.start(),this.walletService.start(),this.waitForApi().then((function(){e.walletBackend.events.emit("ready",e.walletBackend.getApi())})),new Promise((function(t,n){e.walletBackend.events.on("ready",t),e.walletBackend.events.on("exit",n)}))},t.waitForApi=function(){var e=this;return this.logger.debug("waitForApi"),new Promise((function(t){var n,r,o=setInterval((function(){e.apiPort&&(n||e.logger.info("Waiting for tcp port "+(n={port:e.apiPort,host:"127.0.0.1"}).host+":"+n.port+" to accept connections..."),r&&r.destroy(),(r=new i.Socket).connect(n,(function(){e.logger.info("... port is ready."),clearInterval(o),t()})),r.on("error",(function(t){e.logger.debug("waitForApi: not ready yet: "+t)})))}),250)}))},t.stop=function(e){var t=this;return void 0===e&&(e=60),this.logger.debug("Launcher.stop: stopping wallet and node"),Promise.all([this.walletService.stop(e),this.nodeService.stop(e)]).then((function(e){var n={wallet:e[0],node:e[1]};return t.logger.debug("Launcher.stop: both services are stopped.",n),t.walletBackend.events.emit("exit",n),n}))},t.installSignalHandlers=function(){var e=this,t=function(t){e.logger.info("Received "+t+" - stopping services..."),e.walletService.stop(0),e.nodeService.stop(0)};["SIGINT","SIGTERM","SIGHUP","SIGBREAK"].forEach((function(e){return o.on(e,t)}))},e}(),v=function(e){this.baseUrl="http://127.0.0.1:"+e+"/v2/",this.requestParams={port:e,path:"/v2/",hostname:"127.0.0.1"}};function h(){console.log("usage: cardano-launcher BACKEND NETWORK CONFIG-DIR STATE-DIR"),console.log("  BACKEND    - either jormungandr or byron"),console.log("  NETWORK    - depends on backend, e.g. mainnet, itn_rewards_v1"),console.log("  CONFIG-DIR - directory which contains config files for a backend"),console.log("  STATE-DIR  - directory to put blockchains, databases, etc."),o.exit(1)}function w(e){o.send&&o.send(e)}exports.Launcher=S,exports.cli=function(e){var t=setInterval((function(){}),36e5);e.shift(),e.shift(),e.length<4&&h();var n,r=e.shift(),i=e.shift(),a=e.shift(),c=e.shift();"byron"===r?(i in p||(console.error("unknown network: "+i),o.exit(2)),n={kind:r,configurationDir:a,network:p[i]}):"jormungandr"===r?(i in f||(console.error("unknown network: "+i),o.exit(2)),n={kind:r,configurationDir:a,network:f[i]}):h();var l=new S({stateDir:c,nodeConfig:n,networkName:i},console);l.start(),l.nodeService.start().then((function(e){return w({node:e})})),l.walletService.start().then((function(e){return w({wallet:e})})),l.walletBackend.events.on("exit",(function(e){var n,r,i;console.log(d(e.wallet)),console.log(d(e.node)),clearInterval(t),o.exit((r=s.reduce(n=[e.wallet,e.node],(function(e,t){return null===e?t.code:e}),null),i=s.reduce(n,(function(e,t){return null===e?t.signal:e}),null),null===r?null===i?0:127:r))}))},exports.exitStatusMessage=function(e){return s.map(e,d).join("\n")},exports.serviceExitStatusMessage=d;
//# sourceMappingURL=cardano-launcher.cjs.production.min.js.map
